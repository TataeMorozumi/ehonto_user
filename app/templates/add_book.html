{% load custom_filters %}
<style>
  /* モーダル内全体 */
  #addBookForm {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
  }
  
  /* 入力欄の基本スタイル */
  #addBookForm input[type="text"],
  #addBookForm input[type="file"] {
    width: 80%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  
  /* ✅ 本棚チェックボックスを横並びに */
  .checkbox-inline {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  /* ✅ チェックボックスの見やすさ改善 */
  .checkbox-item {
    display: flex;
    align-items: center;
    font-size: 16px;
    font-weight: bold;
    gap: 8px;
  }
  
  /* ✅ チェックボックスサイズを拡大 */
  .checkbox-item input[type="checkbox"] {
    transform: scale(1.5);
  }
  
  /* ✅ 登録ボタン */
  .submit-button {
    background-color: #5cb85c;
    color: white;
    padding: 10px 30px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
  }
  
  .submit-button:hover {
    background-color: #4cae4c;
  }
  </style>
  
  <div id="form-error-box" style="display: none; color: red; margin-bottom: 10px;"></div>
  <form id="addBookForm" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
  
    <!-- ✅ タイトル・作者・画像 -->
    {{ form.title.label_tag }}<br>
    {{ form.title }}<br><br>
  
    {{ form.author.label_tag }}<br>
    {{ form.author }}<br><br>
  
    {{ form.image.label_tag }}<br>
    {{ form.image }}<br><br>
  
    <!-- ✅ 本棚の選択（複数可） -->
    
    <label>{{ form.children.label }}</label>
    <div class="checkbox-inline">
      {% for checkbox in form.children %}
        <label class="checkbox-item">
          {{ checkbox.tag }} {{ checkbox.choice_label }}
        </label>
      {% endfor %}
    </div>

    <!-- ✅ hidden child_id（旧仕様）削除！ -->
    {# <input type="hidden" name="child_id" value="{{ selected_child_id|default_if_none:'' }}"> #}
  
    <button type="submit" class="submit-button">登録</button>
  </form>



{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("addBookForm");
  const errorBox = document.getElementById("form-error-box");

  if (!form) return;

  form.addEventListener("submit", function (event) {
    event.preventDefault();

    const formData = new FormData(form);
    const csrfToken = formData.get("csrfmiddlewaretoken");

    fetch("{% url 'add_book' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken
      },
      body: formData
    })
    .then(response => {
      const contentType = response.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        throw new Error("⚠ JSON形式のレスポンスではありません（HTMLなどが返ってきました）");
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        errorBox.style.display = "none";
        closeModal();
        window.location.reload();
      } else {
        errorBox.textContent = data.error || "登録に失敗しました";
        errorBox.style.display = "block";
      }
    })
    .catch(error => {
      errorBox.textContent = error.message || "通信エラーが発生しました";
      errorBox.style.display = "block";
      console.error("❌ 通信エラー:", error);
    });
  });
});
</script>
{% endblock %}