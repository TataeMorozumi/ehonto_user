{% extends "base.html" %}
{% load dict_extras %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="book-detail-container">

  <!-- âœ… å·¦å´ï¼ˆè¡¨ç´™ç”»åƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‘—è€…ãƒ»ç™»éŒ²æ—¥ï¼‰ -->
  <div class="book-info">
    <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-cover">
    <h2>{{ book.title }}</h2>
    <p>è‘—è€…: {{ book.author }}</p>
    <p>ç™»éŒ²æ—¥: {{ book.created_at|date:"Yå¹´mæœˆdæ—¥" }}</p>

    <!-- âœ… å‰Šé™¤ãƒœã‚¿ãƒ³ -->
    <form method="POST" action="{% url 'delete_book' book.id %}" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
        {% csrf_token %}
        <button type="submit" class="delete-button">å‰Šé™¤</button>
    </form>
  </div>

  <!-- âœ… å³å´ï¼šç™»éŒ²ã—ãŸå­ã©ã‚‚ã®åå‰è¡¨ç¤º -->
  <div class="book-owners" style="text-align: right;">
    {% for child in registered_children %}
      <div class="child-entry" data-child-id="{{ child.id }}">
  
        <!-- ğŸ‘§ åå‰ï¼‹æ˜Ÿï¼‹ã‚ˆã‚“ã  -->
        <div class="child-header">
          <span class="child-icon">ğŸ§‘</span>
          <span class="child-name">{{ child.name }}</span>
  
          <!-- â­ ãŠæ°—ã«å…¥ã‚Š -->
          <span class="favorite-star" data-book-id="{{ book.id }}" data-child-id="{{ child.id }}">
            {% if child.id in favorited_child_ids %}â˜…{% else %}â˜†{% endif %}
          </span>
  
          <!-- ğŸ“– ã‚ˆã‚“ã  -->
          <button class="read-button" data-book-id="{{ book.id }}" data-child-id="{{ child.id }}">ã‚ˆã‚“ã </button>
          <span id="read-count-{{ child.id }}">
            {{ read_counts|get_item:child.id|default:"0" }} å›
          </span>
        </div>
  
        <!-- âœï¸ ãƒ¡ãƒ¢æ¬„ï¼ˆâ†“åå‰ãƒ»ãƒœã‚¿ãƒ³ã®ä¸‹ã«é…ç½®ï¼‰-->
        <div class="memo-box">
          <textarea id="memo-{{ child.id }}">{{ memos|get_item:child.id }}</textarea>
          <button class="memo-save-btn" onclick="saveMemo({{ book.id }}, {{ child.id }})">ãƒ¡ãƒ¢ä¿å­˜</button>
        </div>
        
  
      </div>
    {% endfor %}
  </div>
  

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll(".favorite-star");

    stars.forEach(star => {
        star.addEventListener("click", function () {
            const bookId = this.dataset.bookId;
            const childId = this.dataset.childId;

            fetch("{% url 'toggle_favorite' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({ book_id: bookId, child_id: childId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.favorited) {
                    this.textContent = "â˜…";
                    this.classList.add("favorited");
                } else {
                    this.textContent = "â˜†";
                    this.classList.remove("favorited");
                }
            })
            .catch(error => console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error));
        });
    });


    // ğŸ“– ã‚ˆã‚“ã ãƒœã‚¿ãƒ³ã®å‡¦ç†
      const readButtons = document.querySelectorAll(".read-button");

      readButtons.forEach(button => {
          button.addEventListener("click", function () {
              const bookId = this.dataset.bookId;
              const childId = this.dataset.childId;

              fetch("{% url 'increment_read_count' %}", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/x-www-form-urlencoded",
                      "X-CSRFToken": "{{ csrf_token }}",
                  },
                  body: `book_id=${bookId}&child_id=${childId}`
              })
              .then(response => response.json())
              .then(data => {
                  console.log("âœ… å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:", data); 
                  const countSpan = document.getElementById(`read-count-${childId}`);
                  countSpan.textContent = `${data.count}å›`;
                  
              })
              .catch(error => console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error));
          });
    });

    function saveMemo(bookId, childId) {
      const content = document.getElementById(`memo-${childId}`).value;

      fetch("{% url 'save_memo' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: `book_id=${bookId}&child_id=${childId}&content=${encodeURIComponent(content)}`
      })
      .then(response => response.json())
      .then(data => {
        alert("ğŸ’¾ ãƒ¡ãƒ¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
      })
      .catch(error => {
        console.error("âŒ ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
      });
    }

});
</script>
{% endblock %}
