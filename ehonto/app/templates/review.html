{% extends "base.html" %}
{% load custom_filters %}

{% block title %}ãµã‚Šã‹ãˆã‚Š{% endblock %}

{% block content %}
<!-- ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="calendar-nav">
  <a href="?month={{ prev_month.month }}&year={{ prev_month.year }}">â—€ å‰ã®æœˆ</a>
  <span class="current-month">{{ current_date|date:"Yå¹´næœˆ" }}</span>
  <a href="?month={{ next_month.month }}&year={{ next_month.year }}">æ¬¡ã®æœˆ â–¶</a>
</div>

<!-- ğŸ§’ å­ã©ã‚‚é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
<div class="child-selector">
  <form method="get" action="{% url 'review' %}" id="childSelectForm">
    <label for="child">æœ¬æ£šã‚’é¸æŠ:</label>
    <select name="child_id" id="child" onchange="document.getElementById('childSelectForm').submit()">
      <option value="" {% if not selected_child_id %}selected{% endif %}>å…±é€šã®æœ¬æ£š</option>
      {% for child in children %}
        <option value="{{ child.id }}" {% if selected_child_id == child.id|stringformat:"s" %}selected{% endif %}>
          {{ child.name }}
        </option>
      {% endfor %}
    </select>
  </form>
</div>

<!-- ğŸŒŸ ä»Šæœˆã‚‚ã£ã¨ã‚‚èª­ã¾ã‚ŒãŸçµµæœ¬ -->
{% if most_read_title %}
  <div class="most-read-banner">
    ğŸ“š ä»Šæœˆã‚‚ã£ã¨ã‚‚èª­ã¾ã‚ŒãŸçµµæœ¬ï¼š<strong>{{ most_read_title }}</strong>
  </div>
{% endif %}

<!-- ğŸ“Š æœˆé–“åˆè¨ˆ -->
<div class="monthly-summary">
  <p>ğŸ“š ä»Šæœˆã®èª­ã¿èã‹ã›åˆè¨ˆï¼š{{ monthly_total }} å›</p>
  <ul class="child-read-list">
    {% for child, total in child_totals.items %}
      <li>{{ child }}ï¼š{{ total }} å›</li>
    {% endfor %}
  </ul>
  
</div>

<!-- ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="calendar-grid">
  {% for weekday in "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"|make_list %}
    <div class="calendar-weekday">{{ weekday }}</div>
  {% endfor %}

  {% for day in calendar_days %}
  <div class="calendar-cell">
    <div class="calendar-day">{{ day }}</div>
    {% with day|stringformat:"s" as day_str %}
      {% with calendar_data|get_item:day_str as books %}
        {% if books %}
          <div class="book-icon" onclick="openBookModal('{{ day_str }}')">ğŸ“–</div>
        {% endif %}
      {% endwith %}
    {% endwith %}
  </div>
{% endfor %}

</div>


<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœ¬ã®ç”»åƒã‚’è¡¨ç¤ºï¼‰ -->
<div id="bookModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeBookModal()">&times;</span>
    <div id="modalBookImages"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  /* âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚°ãƒªãƒƒãƒ‰3åˆ—ï¼‰ */
  #modalBookImages {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 1è¡Œã«3æšãšã¤ */
    gap: 12px;
    padding: 10px;
  }

  #modalBookImages img.book-thumbnail {
    width: 100%;
    height: auto;
    max-height: 200px;
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .modal-content {
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
  }
</style>

<script>
  const bookDetailBase = "{% url 'book_detail' 0 %}".replace("0/", "");  // âœ… ã“ã“ï¼

  window.calendarData = JSON.parse(`{{ calendar_data_json|escapejs }}`);
  console.log("ğŸ“¦ calendarData:", calendarData);

  // âœ… base.html ã® window.openBookModal ã‚’ä¸Šæ›¸ã
  window.openBookModal = function(dayStr) {
    console.log("ğŸ“£ openBookModal:", dayStr);
    const books = calendarData[dayStr];
    if (!books) {
      console.warn("ğŸ“… ãƒ‡ãƒ¼ã‚¿ãªã—: ", dayStr);
      return;
    }

    const container = document.getElementById("modalBookImages");
    container.innerHTML = "";

    books.forEach(book => {
      console.log("ğŸ“˜ book:", book);  // â† book.id ãŒå‡ºã‚‹ã¯ãš

      const link = document.createElement("a");
      link.href = `${bookDetailBase}${book.id}/`;

      console.log("ğŸ”— é·ç§»URL:", link.href);
      link.target = "_self";

      const img = document.createElement("img");
      img.src = book.image_url;
      img.alt = book.title;
      img.classList.add("book-thumbnail");

      link.appendChild(img);
      container.appendChild(link);
    });

    document.getElementById("bookModal").style.display = "block";
  };

  window.closeBookModal = function () {
    document.getElementById("bookModal").style.display = "none";
  };
</script>
{% endblock %}
