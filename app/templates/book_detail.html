{% extends "base.html" %}
{% load dict_extras %}
{% load static %}
{% load custom_filters %}

{% block content %}
<a href="javascript:history.back()" onclick="if(history.length <= 1) location.href='{% url 'home' %}'" class="back-button">â† æœ¬æ£šã«æˆ»ã‚‹</a>


<div class="book-detail-container">

  <!-- âœ… å·¦å´ï¼ˆè¡¨ç´™ç”»åƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‘—è€…ãƒ»ç™»éŒ²æ—¥ï¼‰ -->
  <div class="book-info">
    <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-cover">
    <h2>{{ book.title }}</h2>
    <p>ä½œè€…: {{ book.author }}</p>
    <p>ç™»éŒ²æ—¥: {{ book.created_at|date:"Yå¹´mæœˆdæ—¥" }}</p>

    <!-- âœ… ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆç”»åƒã®ä¸‹ãªã©ã«é…ç½®ï¼‰ -->
    <button class="read-button" onclick="openEditModal()" title="ã“ã®çµµæœ¬ã‚’ç·¨é›†ã™ã‚‹">
      ç·¨é›†âœï¸ 
    </button>

    <!-- âœ… ã”ã¿ç®±ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ -->
    <form method="POST" action="{% url 'delete_book' book.id %}" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" style="display: inline;">
      {% csrf_token %}
      <button type="submit" class="delete-icon-button" title="å‰Šé™¤">
        ğŸ—‘ï¸
      </button>
    </form>

  </div>

  <!-- âœ… å³å´ï¼šç™»éŒ²ã—ãŸå­ã©ã‚‚ã®åå‰è¡¨ç¤º -->
  <div class="book-owners" style="text-align: right;">
    {% for child in registered_children %}
    <div class="child-entry">
      <div class="child-info-row">
        <!-- ğŸ§‘ åå‰ + â˜† + ã‚ˆã‚“ã  + å›æ•° -->
        <div class="child-meta">
          <span class="child-icon">ğŸ§’</span>
          <span class="child-name">{{ child.name }}</span>
          <span class="favorite-star"
                data-book-id="{{ book.id }}"
                data-child-id="{{ child.id }}">
            {% if child.id in favorited_child_ids %}â˜…{% else %}â˜†{% endif %}
          </span>
          <button class="read-button"
                  data-book-id="{{ book.id }}"
                  data-child-id="{{ child.id }}">
            ã‚ˆã‚“ã ï¼‹
          </button>
          <span class="read-count" id="read-count-{{ child.id }}">
            {{ read_counts|get_item:child.id|default:"0" }} å›
          </span>
          <button class="read-decrement"
                  onclick="decrementRead('{{ book.id }}', '{{ child.id }}')">
            ï¼
          </button>
          <button class="remove-child-btn" 
                  data-book-id="{{ book.id }}" 
                  data-child-id="{{ child.id }}" 
                  title="ã“ã©ã‚‚ã®æœ¬æ£šã‹ã‚‰å‰Šé™¤">
            ğŸ—‘ï¸
          </button>

          


        </div>

    
        <!-- ğŸ“ ãƒ¡ãƒ¢æ¬„ -->
        <div class="memo-box-inline">
          <textarea
            id="memo-{{ child.id }}"
            data-book-id="{{ book.id }}"
            data-child-id="{{ child.id }}"
            class="memo-textarea">{{ memos|get_item:child.id|default_if_none:"" }}</textarea>

            <button
              class="memo-save-btn"
              data-book-id="{{ book.id }}"
              data-child-id="{{ child.id }}">
              ä¿å­˜
          </button>
        </div>
        
      </div>
    </div>
  {% endfor %}
</div>
<div id="toast" class="toast" style="display: none;">ä¿å­˜ã—ã¾ã—ãŸ âœ…</div>

<!-- âœ… ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editBookModal" class="modal"  style="display: none;">
  <div class="modal-content edit-book-content">
    <span class="close" onclick="closeEditModal()" style="position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; z-index: 9999;">âœ–</span>

    <h3>çµµæœ¬æƒ…å ±ã‚’ç·¨é›†</h3>

    <form id="editBookForm" method="POST" enctype="multipart/form-data" action="{% url 'edit_book' book.id %}">
      {% csrf_token %}
      <div class="form-group">
        <label>ã‚¿ã‚¤ãƒˆãƒ«ï¼š</label>
        <input type="text" name="title" value="{{ book.title }}">
      </div>

      <div class="form-group">
        <label>ä½œè€…ï¼š</label>
        <input type="text" name="author" value="{{ book.author }}">
      </div>

      <div class="form-group">
        <label>ç”»åƒï¼š</label>
        <input type="file" name="image">
      </div>

      <button type="submit" class="submit-button">ä¿å­˜</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll(".favorite-star");
    const closeBtn = document.querySelector(".modal .close");
    console.log("âœ–ï¸ ãƒœã‚¿ãƒ³è¦ç´ :", closeBtn);

    stars.forEach(star => {
        star.addEventListener("click", function () {
            const bookId = this.dataset.bookId;
            const childId = this.dataset.childId;

            fetch("{% url 'toggle_favorite' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({ book_id: bookId, child_id: childId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.favorited) {
                    this.textContent = "â˜…";
                    this.classList.add("favorited");
                } else {
                    this.textContent = "â˜†";
                    this.classList.remove("favorited");
                }
            })
            .catch(error => console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error));
        });
    });


    // ğŸ“– ã‚ˆã‚“ã ãƒœã‚¿ãƒ³ã®å‡¦ç†
      const readButtons = document.querySelectorAll(".read-button");

      readButtons.forEach(button => {
          button.addEventListener("click", function () {
              const bookId = this.dataset.bookId;
              const childId = this.dataset.childId;

              fetch("{% url 'increment_read_count' %}", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/x-www-form-urlencoded",
                      "X-CSRFToken": "{{ csrf_token }}",
                  },
                  body: `book_id=${bookId}&child_id=${childId}`
              })
              .then(response => response.json())
              .then(data => {
                  console.log("âœ… å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:", data); 
                  const countSpan = document.getElementById(`read-count-${childId}`);
                  countSpan.textContent = `${data.count}å›`;
                  
              })
              .catch(error => console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error));
            });
          });

           // ğŸ’¾ ãƒ¡ãƒ¢ä¿å­˜ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆã“ã“ã‹ã‚‰è¿½åŠ ï¼ï¼‰
    const memoButtons = document.querySelectorAll(".memo-save-btn");
    memoButtons.forEach(button => {
      button.addEventListener("click", function () {
        const bookId = this.dataset.bookId;
        const childId = this.dataset.childId;
        saveMemo(bookId, childId);
      });
    });

  function saveMemo(bookId, childId) {
    const content = document.getElementById(`memo-${childId}`).value;

    fetch("{% url 'save_memo' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: `book_id=${bookId}&child_id=${childId}&content=${encodeURIComponent(content)}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "ok") {
        showToast("ğŸ’¾ ãƒ¡ãƒ¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
      } else {
        showToast("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    })
    .catch(error => {
      console.error("âŒ ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
      showToast("âš  é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    });
  }
  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  }

  window.openEditModal = function () {
    const modal = document.getElementById("editBookModal");
    modal.style.display = "flex";  // â† ã“ã‚Œã ã‘ã§OK
  }
  window.closeEditModal = function () {
    const modal = document.getElementById("editBookModal");
    modal.style.display = "none";
  }
  window.decrementRead = function (bookId, childId) {
    bookId = parseInt(bookId);
    childId = parseInt(childId);
    
    console.log("ğŸ“‰ æ¸›ã‚‰ã™:", bookId, childId);  // â†ç¢ºèªç”¨ãƒ­ã‚°

    fetch("{% url 'decrement_read_count' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ book_id: bookId, child_id: childId })
    })
    .then(response => response.json())
    .then(data => {
      console.log("ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);  // â†çµæœç¢ºèª
      if (data.success) {
        const countElement = document.getElementById(`read-count-${childId}`);
        countElement.textContent = `${data.count} å›`;
      }
    })
    .catch(error => {
      console.error("âŒ ã‚¨ãƒ©ãƒ¼:", error);
    });
  };

});
document.addEventListener("DOMContentLoaded", function () {
    const menuButton = document.getElementById("menu-button");
    const navMenu = document.getElementById("nav-menu");

    if (menuButton && navMenu) {
      menuButton.addEventListener("click", function () {
        console.log("ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
        navMenu.classList.toggle("show");
      });
    } else {
      console.error("ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    }
  });

  document.querySelectorAll('.remove-child-btn').forEach(btn => {
  btn.addEventListener('click', function () {
    const bookId = this.dataset.bookId;
    const childId = this.dataset.childId;
    if (!confirm("ã“ã®å­ã©ã‚‚ã¨ã®ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

    fetch("{% url 'remove_child_from_book' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `book_id=${bookId}&child_id=${childId}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    });
  });
});

</script>
{% endblock %}
