{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<h2 style="text-align: center; margin-top: 10px;"></h2>

<!-- âœ… å­ã©ã‚‚æœ¬æ£šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ ï¼‹ æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  æ¨ªä¸¦ã³ -->
<div class="toolbar-container">
    <div class="child-selector">
        <form method="get" action="{% url 'home' %}" id="childSelectForm">
            <label for="child">æœ¬æ£šã‚’é¸æŠ:</label>
            <select name="child_id" id="child" onchange="document.getElementById('childSelectForm').submit()">
                <option value="" {% if not selected_child_id %}selected{% endif %}>å…±é€šã®æœ¬æ£š</option>
                {% for child in children %}
                <option value="{{ child.id }}" {% if selected_child_id == child.id|stringformat:"s" %}selected{% endif %}>{{ child.name }}</option>
                {% endfor %}
            </select>
        </form>
        <a href="{% url 'child_edit' %}" class="icon child-edit-icon custom-tooltip">
            ğŸ“
            <span class="tooltip-text">å­ã©ã‚‚ã‚’ç™»éŒ²ãƒ»ç·¨é›†</span>
        </a>
    </div>

    <form method="get" action="{% url 'search_results' %}" class="search-form">
        <input type="text" name="q" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ä½œè€…ã§æ¤œç´¢" class="search-input">
        <button type="submit" class="search-button">æ¤œç´¢</button>
    </form>
</div>

<!-- âœ… ç™»éŒ²ã•ã‚ŒãŸçµµæœ¬ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div class="book-list">
    {% if book_rows %}
        {% for row in book_rows %}
            <div class="book-row">
                {% for book in row %}
                    {% if book.image %}
                        <div class="book-item">
                            <a href="{% url 'book_detail' book.id %}">
                                <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-image">
                            </a>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% if not request.path == '/search/' %}
                <div class="shelf-line"></div>
            {% endif %}
        {% endfor %}
    {% else %}
        <p class="no-books-message">ã“ã®æœ¬æ£šã«ã¯ã¾ã çµµæœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<!-- âœ… ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page=1{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">æœ€åˆ</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">å‰ã¸</a>
    {% endif %}
    <span>ãƒšãƒ¼ã‚¸ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">æ¬¡ã¸</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">æœ€å¾Œ</a>
    {% endif %}
</div>

<button id="addBookButton" class="add-button">ï¼‹</button>

{% block scripts %}
<script>
   console.log("âœ… base.html ã® JavaScript èª­ã¿è¾¼ã¾ã‚ŒãŸ");

   document.addEventListener("DOMContentLoaded", function () {
       // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºèª
       const addBookButton = document.getElementById("addBookButton");
       
       if (addBookButton) {
           console.log("ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ");
           addBookButton.addEventListener("click", function(event) {
               console.log("ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ");  // ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
               event.preventDefault();  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’é˜²æ­¢
               loadAddBookModal('{{ selected_child_id }}');
           });
       } else {
           console.error("ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
       }

       // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
       window.loadAddBookModal = function (childId = null) {
           console.log("âœ… loadAddBookModal å®Ÿè¡Œ", childId);
           const modal = document.getElementById("addBookModal");
           const modalBody = document.getElementById("modal-body");

           fetch("{% url 'add_book' %}" + (childId ? "?child_id=" + childId : ""))
               .then(response => response.text())
               .then(html => {
                   console.log("ãƒ•ã‚©ãƒ¼ãƒ èª­ã¿è¾¼ã¿æˆåŠŸ");
                   const parser = new DOMParser();
                   const doc = parser.parseFromString(html, "text/html");
                   const form = doc.querySelector("form");

                   if (childId) {
                       const hiddenInput = document.createElement("input");
                       hiddenInput.type = "hidden";
                       hiddenInput.name = "child_id";
                       hiddenInput.value = childId;
                       form.appendChild(hiddenInput);
                   }

                   form.addEventListener("submit", function (event) {
                       event.preventDefault();
                       submitAddBookForm(form, childId);
                   });

                   modalBody.innerHTML = "";
                   modalBody.appendChild(form);
                   modal.style.display = "flex";
               })
               .catch(error => {
                   modalBody.innerHTML = "<p>ãƒ•ã‚©ãƒ¼ãƒ èª­ã¿è¾¼ã¿å¤±æ•—</p>";
                   console.error("âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¨ãƒ©ãƒ¼:", error);
               });
       };

       window.closeModal = function () {
           document.getElementById("addBookModal").style.display = "none";
       };

       window.submitAddBookForm = function (form, childId) {
           const formData = new FormData(form);
           if (childId) {
               formData.append("child_id", childId);
           }

           const errorBox = form.querySelector("#form-error-box");

           fetch("{% url 'add_book' %}", {
               method: "POST",
               body: formData,
               headers: {
                   "X-CSRFToken": formData.get("csrfmiddlewaretoken")
               }
           })
           .then(response => {
               const contentType = response.headers.get("content-type") || "";
               if (!contentType.includes("application/json")) {
                   throw new Error("âš  JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
               }
               return response.json();
           })
           .then(data => {
               if (data.success) {
                   if (errorBox) errorBox.style.display = "none";
                   closeModal();
                   window.location.reload();
               } else {
                   if (errorBox) {
                       errorBox.textContent = data.error || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ";
                       errorBox.style.display = "block";
                   } else {
                       alert(data.error || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
                   }
               }
           })
           .catch(error => {
               console.error("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error);
               if (errorBox) {
                   errorBox.textContent = error.message || "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                   errorBox.style.display = "block";
               }
           });
       };
   });
</script>
{% endblock %}
