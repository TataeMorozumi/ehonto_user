{% extends "base.html" %}

{% block content %}
<h2>{{ selected_child.name }} ã®æœ¬æ£š</h2>

<div class="book-container">
    {% for book in books %}
        {% if book.image %}
            <div class="book-item">
                <a href="{% url 'book_detail' book.id %}">
                    <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-image">
                </a>
            </div>
        {% endif %}
    {% empty %}
        <p class="text-center">ã“ã®æœ¬æ£šã«ã¯ã¾ã çµµæœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}
</div>

<!-- âœ… ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ï¼ˆå­ã©ã‚‚ã®æœ¬æ£šç”¨ï¼‰ -->
<a href="#" class="add-button" onclick="loadAddBookModal('{{ selected_child.id }}')">ï¼‹</a>

<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
<div id="addBookModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body">
            <!-- ã“ã“ã« `/add_book/` ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ -->
        </div>
    </div>
</div>

<!-- âœ… å…±é€šã®æœ¬æ£šã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<a href="{% url 'home' %}" class="btn btn-secondary">å…±é€šã®æœ¬æ£šã¸æˆ»ã‚‹</a>

{% endblock %}

{% block scripts %}
<script>
    function loadAddBookModal(childId) {
        console.log("ğŸ“Œ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™");
        const modal = document.getElementById("addBookModal");
        const modalBody = document.getElementById("modal-body");

        fetch("{% url 'add_book' %}")
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const form = doc.querySelector("form");

                // âœ… éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¦å­ã©ã‚‚ã®IDã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "child_id";
                hiddenInput.value = childId;
                form.appendChild(hiddenInput);

                modalBody.innerHTML = form.outerHTML;
                modal.style.display = "flex";
                window.history.pushState({}, '', "{% url 'add_book' %}");
            })
            .catch(error => {
                console.error("âŒ ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:", error);
                modalBody.innerHTML = "<p>ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
            });
    }

    function closeModal() {
        console.log("ğŸ“Œ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã™");
        const modal = document.getElementById("addBookModal");
        modal.style.display = "none";
        modal.classList.remove("modal-show");
        window.history.pushState({}, '', "{% url 'child_bookshelf' child_id=selected_child.id %}");
    }

    window.onclick = function(event) {
        const modal = document.getElementById("addBookModal");
        if (event.target === modal) {
            closeModal();
        }
    };
</script>
{% endblock %}
