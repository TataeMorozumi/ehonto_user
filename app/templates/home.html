{% extends "base.html" %}  <!-- âœ… æœ€åˆã«é…ç½® -->
{% block body_class %}home-page{% endblock %}

{% load static %}  <!-- âœ… `extends` ã®ã™ãå¾Œã«é…ç½® -->

{% block content %}
<h2 style="text-align: center; margin-top: 10px;"></h2>

<!-- âœ… å­ã©ã‚‚æœ¬æ£šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ ï¼‹ æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  æ¨ªä¸¦ã³ -->
<div class="toolbar-container">
    <!-- ğŸ”½ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="child-selector">
      <form method="get" action="{% url 'home' %}" id="childSelectForm">
        <label for="child">æœ¬æ£šã‚’é¸æŠ:</label>
        <select name="child_id" id="child" onchange="document.getElementById('childSelectForm').submit()">
          <option value="" {% if not selected_child_id %}selected{% endif %}>å…±é€šã®æœ¬æ£š</option>
          {% for child in children %}
            <option value="{{ child.id }}" {% if selected_child_id == child.id|stringformat:"s" %}selected{% endif %}>
              {{ child.name }}
            </option>
          {% endfor %}
        </select>
        <a href="{% url 'child_edit' %}" class="child-edit-icon">ğŸ“</a>
      </form>
    </div>
  
    <!-- ğŸ” æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form method="get" action="{% url 'search_results' %}" class="search-form">
      <input type="text" name="q" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ä½œè€…ã§æ¤œç´¢" class="search-input">
      <button type="submit" class="search-button">æ¤œç´¢</button>
    </form>
  </div>
<!-- âœ… ç™»éŒ²ã•ã‚ŒãŸçµµæœ¬ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div class="book-list">
  {% if book_rows %}
    {% for row in book_rows %}
      <div class="book-row">
        {% for book in row %}
          {% if book.image %}
            <div class="book-item">
              <a href="{% url 'book_detail' book.id %}">
                <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-image">
              </a>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      {% if not request.path == '/search/' %}
      <div class="shelf-line"></div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="no-books-message">ã“ã®æœ¬æ£šã«ã¯ã¾ã çµµæœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>


<!-- âœ… ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="pagination">
  {% if page_obj.has_previous %}
    <a href="?page=1{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">æœ€åˆ</a>
    <a href="?page={{ page_obj.previous_page_number }}{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">å‰ã¸</a>
  {% endif %}

  <span>ãƒšãƒ¼ã‚¸ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">æ¬¡ã¸</a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if selected_child_id %}&child_id={{ selected_child_id }}{% endif %}">æœ€å¾Œ</a>
  {% endif %}
</div>

<!-- âœ… ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã -->
<a href="#" class="add-button" onclick="event.preventDefault(); loadAddBookModal('{{ selected_child_id }}');">ï¼‹</a>

<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
<div id="addBookModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body">
            <!-- ã“ã“ã« `/add_book/` ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ -->
        </div>
    </div>
</div>

{% endblock %}  <!-- âœ… content ãƒ–ãƒ­ãƒƒã‚¯ã®çµ‚äº† -->


{% block scripts %}
<script>

  // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
  function loadAddBookModal(childId = null) {
    const modal = document.getElementById("addBookModal");
    const modalBody = document.getElementById("modal-body");

    fetch("{% url 'add_book' %}?child_id=" + childId)
      .then(response => response.text())
      .then(html => {
        modalBody.innerHTML = html;
        modal.style.display = "flex";
      })
      .catch(error => {
        modalBody.innerHTML = "<p>ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
        console.error("âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¨ãƒ©ãƒ¼:", error);
      });
  }

  function closeModal() {
    document.getElementById("addBookModal").style.display = "none";
  }
</script>
{% endblock %}


